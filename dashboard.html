<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | The Royal Cafe & Restaurant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-brand { font-family: 'Playfair Display', serif; }
        .stat-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
        .nav-active { color: white; background-color: #4f46e5; }
        .modal { transition: opacity 0.3s ease; }
        .spinner { border: 4px solid rgba(0,0,0,.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">
    <!-- Main Application Container -->
    <div class="flex h-screen bg-gray-100">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-white shadow-md flex flex-col">
            <div class="p-6 text-center border-b">
                <h1 class="font-brand text-2xl text-gray-800">The Royal Cafe</h1>
                <p class="text-sm text-gray-500">Admin Panel</p>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-6 space-y-2">
                <a href="#dashboard" class="nav-link flex items-center px-4 py-3 rounded-lg font-semibold nav-active">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </a>
                <a href="#menu" class="nav-link flex items-center px-4 py-3 text-gray-600 hover:bg-gray-200 rounded-lg font-semibold">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    Menu Management
                </a>
                <a href="./index.html" class="flex items-center px-4 py-3 text-gray-600 hover:bg-gray-200 rounded-lg font-semibold">
                     <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 8h.01M15 8h.01M15 5h.01M12 5h.01M9 5h.01M4 7h16a1 1 0 011 1v10a1 1 0 01-1 1H4a1 1 0 01-1-1V8a1 1 0 011-1z"></path></svg>
                    Billing System
                </a>
            </nav>
            <div class="p-4 border-t text-xs text-gray-500"><p>&copy; 2024 The Royal Cafe & Restaurant</p></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Dashboard View -->
            <div id="dashboardView" class="p-6 md:p-10">
                <header class="mb-8"><h2 class="text-3xl font-bold text-gray-900">Dashboard</h2><p id="currentDate" class="text-gray-500"></p></header>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-lg flex items-center"><div class="p-4 bg-blue-100 rounded-full mr-4"><svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg></div><div><p class="text-gray-500 font-semibold">Today's Sales</p><p id="todaysSales" class="text-3xl font-bold">₹0.00</p></div></div>
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-lg flex items-center"><div class="p-4 bg-green-100 rounded-full mr-4"><svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div><div><p class="text-gray-500 font-semibold">Today's Orders</p><p id="todaysOrders" class="text-3xl font-bold">0</p></div></div>
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-lg flex items-center"><div class="p-4 bg-yellow-100 rounded-full mr-4"><svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div><div><p class="text-gray-500 font-semibold">Upcoming Bookings</p><p id="upcomingBookings" class="text-3xl font-bold">0</p></div></div>
                    <div class="stat-card bg-white p-6 rounded-2xl shadow-lg flex items-center"><div class="p-4 bg-purple-100 rounded-full mr-4"><svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 013.445-2.586m-3.445 2.586a3 3 0 00-3.445-2.586m3.445 2.586L11 14m-3.445 2.586a3 3 0 01-3.445-2.586M12 12a3 3 0 110-6 3 3 0 010 6z"></path></svg></div><div><p class="text-gray-500 font-semibold">Total Customers</p><p id="totalCustomers" class="text-3xl font-bold">0</p></div></div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <div class="xl:col-span-2 bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">Recent Orders</h3><div id="recentOrdersContainer"><div class="loader-container flex justify-center items-center h-48"><div class="spinner"></div></div></div></div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-bold mb-4">Upcoming Bookings</h3><div id="upcomingBookingsContainer"><div class="loader-container flex justify-center items-center h-48"><div class="spinner"></div></div></div></div>
                </div>
            </div>
            <!-- Menu Management View -->
            <div id="menuView" class="p-6 md:p-10 hidden">
                 <header class="mb-8 flex justify-between items-center"><div><h2 class="text-3xl font-bold text-gray-900">Menu & Rate Management</h2><p class="text-gray-500">Add, edit, or remove menu items.</p></div><button id="addNewItemBtn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700">Add New Item</button></header>
                <div class="bg-white p-6 rounded-2xl shadow-lg"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b bg-gray-50"><th class="p-4 font-semibold">Item</th><th class="p-4 font-semibold">Category</th><th class="p-4 font-semibold">Price</th><th class="p-4 font-semibold">Actions</th></tr></thead><tbody id="menuTableBody"><tr><td colspan="4"><div class="loader-container flex justify-center items-center h-48"><div class="spinner"></div></div></td></tr></tbody></table></div></div>
            </div>
        </main>
    </div>
    <!-- Modals -->
    <div id="menuItemModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0"><div class="bg-white rounded-lg shadow-2xl max-w-lg w-full p-6 mx-auto"><form id="menuItemForm"><h3 id="modalTitle" class="text-2xl font-bold mb-6">Add New Menu Item</h3><input type="hidden" id="menuItemId"><div class="space-y-4"><div><label for="itemName" class="block text-sm font-medium text-gray-700">Item Name</label><input type="text" id="itemName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div><div><label for="itemCategory" class="block text-sm font-medium text-gray-700">Category</label><select id="itemCategory" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required><option>Soups</option><option>Appetizers</option><option>Main Course</option><option>Indian Breads</option><option>Rice & Biryani</option><option>Chinese</option><option>Beverages</option><option>Desserts</option></select></div><div><label for="itemPrice" class="block text-sm font-medium text-gray-700">Price (₹)</label><input type="number" id="itemPrice" step="0.01" min="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required></div><div><label for="itemImage" class="block text-sm font-medium text-gray-700">Image URL</label><input type="url" id="itemImage" placeholder="https://placehold.co/..." class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></div></div><div class="mt-8 flex justify-end gap-3"><button type="button" id="cancelModalBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" id="saveItemBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Item</button></div></form></div></div>
    <div id="deleteConfirmModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0"><div class="bg-white rounded-lg shadow-2xl max-w-sm w-full p-6 mx-auto text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div><h3 class="text-lg font-medium text-gray-900">Delete Item?</h3><p class="text-sm text-gray-500 mt-2">Are you sure you want to delete <strong id="itemNameToDelete"></strong>? This action cannot be undone.</p><div class="mt-6 flex justify-center gap-3"><button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Confirm Delete</button></div></div></div>

    <script>
        // --- CONFIGURATION ---
        const API_BASE_URL = 'http://localhost:3000/api';

        // --- DOM ELEMENTS ---
        const todaysSalesEl = document.getElementById('todaysSales');
        const todaysOrdersEl = document.getElementById('todaysOrders');
        const upcomingBookingsEl = document.getElementById('upcomingBookings');
        const totalCustomersEl = document.getElementById('totalCustomers');
        const recentOrdersContainer = document.getElementById('recentOrdersContainer');
        const upcomingBookingsContainer = document.getElementById('upcomingBookingsContainer');
        const menuTableBody = document.getElementById('menuTableBody');

        // --- Navigation ---
        const sidebarNav = document.getElementById('sidebarNav');
        const views = { dashboard: document.getElementById('dashboardView'), menu: document.getElementById('menuView') };
        sidebarNav.addEventListener('click', (e) => {
            const link = e.target.closest('.nav-link');
            if (!link) return;
            e.preventDefault();
            const targetView = link.getAttribute('href').substring(1);
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('nav-active'));
            link.classList.add('nav-active');
            for (const view in views) views[view].classList.toggle('hidden', view !== targetView);
        });

        // --- DATA FETCHING & RENDERING ---
        async function fetchDashboardStats() {
            try {
                const res = await fetch(`${API_BASE_URL}/dashboard-stats`);
                if (!res.ok) throw new Error('Network response was not ok');
                const stats = await res.json();
                todaysSalesEl.textContent = `₹${stats.totalSales.toFixed(2)}`;
                todaysOrdersEl.textContent = stats.orderCount;
                upcomingBookingsEl.textContent = stats.bookingCount;
                totalCustomersEl.textContent = stats.customerCount;
            } catch (error) { console.error("Error fetching dashboard stats:", error); }
        }

        async function fetchRecentOrders() {
            try {
                const res = await fetch(`${API_BASE_URL}/recent-orders`);
                const orders = await res.json();
                recentOrdersContainer.innerHTML = '';
                if (orders.length === 0) { recentOrdersContainer.innerHTML = `<p class="text-gray-500 text-center py-10">No recent orders.</p>`; return; }
                orders.forEach(order => {
                    const orderTime = new Date(order.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const items = order.items.map(i => `${i.name} (x${i.quantity})`).join(', ');
                    recentOrdersContainer.innerHTML += `<div class="flex items-center justify-between p-4 border-b last:border-b-0"><div><p class="font-bold">Order #${order._id.slice(-6)}</p><p class="text-sm text-gray-500 truncate" title="${items}">${items}</p></div><div class="text-right"><p class="font-bold text-lg text-indigo-600">₹${order.grandTotal.toFixed(2)}</p><p class="text-sm text-gray-400">${orderTime}</p></div></div>`;
                });
            } catch (error) { console.error("Error fetching recent orders:", error); }
        }

        async function fetchUpcomingBookings() {
            try {
                const res = await fetch(`${API_BASE_URL}/upcoming-bookings`);
                const bookings = await res.json();
                upcomingBookingsContainer.innerHTML = '';
                if (bookings.length === 0) { upcomingBookingsContainer.innerHTML = `<p class="text-gray-500 text-center py-10">No upcoming bookings.</p>`; return; }
                bookings.forEach(booking => {
                    const d = new Date(booking.bookingDateTime);
                    const date = d.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    const time = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    upcomingBookingsContainer.innerHTML += `<div class="p-4 border-b last:border-b-0"><div class="flex justify-between items-center"><p class="font-bold">${booking.name}</p><span class="text-sm font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">${booking.guests} Guests</span></div><p class="text-sm text-gray-500">${date} at ${time}</p></div>`;
                });
            } catch (error) { console.error("Error fetching upcoming bookings:", error); }
        }

        async function fetchMenuItems() {
            try {
                const res = await fetch(`${API_BASE_URL}/menu`);
                const menuItems = await res.json();
                
                menuItems.sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name));
                
                menuTableBody.innerHTML = '';
                if (menuItems.length === 0) {
                    menuTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-gray-500">No menu items found.</td></tr>`;
                    return;
                }
                menuItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b last:border-b-0';
                    row.innerHTML = `<td class="p-4 flex items-center"><img src="${item.image || 'https://placehold.co/60x40/E2E8F0/475569?text=No+Img'}" alt="${item.name}" class="w-16 h-10 object-cover rounded-md mr-4"><span class="font-semibold">${item.name}</span></td><td class="p-4 text-gray-600">${item.category}</td><td class="p-4 font-semibold">₹${item.price.toFixed(2)}</td><td class="p-4"><button class="edit-btn text-indigo-600 hover:text-indigo-900 font-semibold mr-4" data-id="${item._id}">Edit</button><button class="delete-btn text-red-600 hover:text-red-900 font-semibold" data-id="${item._id}" data-name="${item.name}">Delete</button></td>`;
                    menuTableBody.appendChild(row);
                });
            } catch (error) { console.error("Error fetching menu items:", error); }
        }

        // --- MODAL & FORM LOGIC ---
        const menuItemModal = document.getElementById('menuItemModal');
        const menuItemForm = document.getElementById('menuItemForm');
        const modalTitle = document.getElementById('modalTitle');
        const menuItemIdInput = document.getElementById('menuItemId');

        function openModal(modalId) { document.getElementById(modalId).classList.remove('hidden', 'opacity-0'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden', 'opacity-0'); }

        document.getElementById('addNewItemBtn').addEventListener('click', () => {
            menuItemForm.reset();
            menuItemIdInput.value = '';
            modalTitle.textContent = 'Add New Menu Item';
            openModal('menuItemModal');
        });

        menuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = menuItemIdInput.value;
            const itemData = { name: itemName.value, category: itemCategory.value, price: parseFloat(itemPrice.value), image: itemImage.value };
            const method = itemId ? 'PUT' : 'POST';
            const url = itemId ? `${API_BASE_URL}/menu/${itemId}` : `${API_BASE_URL}/menu`;
            
            saveItemBtn.disabled = true;
            saveItemBtn.textContent = 'Saving...';
            try {
                const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(itemData) });
                if (!res.ok) throw new Error('Failed to save item');
                closeModal('menuItemModal');
                fetchMenuItems(); // Refresh menu
            } catch (error) { console.error("Error saving menu item:", error); alert("Could not save item."); } 
            finally { saveItemBtn.disabled = false; saveItemBtn.textContent = 'Save Item'; }
        });
        
        document.getElementById('cancelModalBtn').addEventListener('click', () => closeModal('menuItemModal'));

        // --- DELETE LOGIC ---
        let itemToDeleteId = null;
        menuTableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('edit-btn')) {
                const itemId = e.target.dataset.id;
                const row = e.target.closest('tr');
                modalTitle.textContent = 'Edit Menu Item';
                menuItemIdInput.value = itemId;
                itemName.value = row.cells[0].querySelector('span').textContent;
                itemCategory.value = row.cells[1].textContent;
                itemPrice.value = parseFloat(row.cells[2].textContent.replace('₹', ''));
                itemImage.value = row.cells[0].querySelector('img').src.startsWith('https://placehold.co') ? '' : row.cells[0].querySelector('img').src;
                openModal('menuItemModal');
            }
            if (e.target.classList.contains('delete-btn')) {
                itemToDeleteId = e.target.dataset.id;
                document.getElementById('itemNameToDelete').textContent = e.target.dataset.name;
                openModal('deleteConfirmModal');
            }
        });
        document.getElementById('cancelDeleteBtn').addEventListener('click', () => closeModal('deleteConfirmModal'));
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!itemToDeleteId) return;
            confirmDeleteBtn.disabled = true;
            confirmDeleteBtn.textContent = 'Deleting...';
            try {
                const res = await fetch(`${API_BASE_URL}/menu/${itemToDeleteId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Failed to delete');
                closeModal('deleteConfirmModal');
                fetchMenuItems(); // Refresh menu
            } catch (error) { console.error("Error deleting item:", error); alert("Could not delete item."); }
            finally { itemToDeleteId = null; confirmDeleteBtn.disabled = false; confirmDeleteBtn.textContent = 'Confirm Delete'; }
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            fetchDashboardStats();
            fetchRecentOrders();
            fetchUpcomingBookings();
            fetchMenuItems();
        };
    </script>
</body>
</html>

